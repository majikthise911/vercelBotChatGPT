"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.KeyValueStore = void 0;
var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));
var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));
var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));
var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));
var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));
var _util = require("util");
var _file = require("./file.js");
var _steamship_error = require("./steamship_error.js");
var _tag = require("./tag.js");
function _createForOfIteratorHelper(o, allowArrayLike) { var it = typeof Symbol !== "undefined" && o[Symbol.iterator] || o["@@iterator"]; if (!it) { if (Array.isArray(o) || (it = _unsupportedIterableToArray(o)) || allowArrayLike && o && typeof o.length === "number") { if (it) o = it; var i = 0; var F = function F() {}; return { s: F, n: function n() { if (i >= o.length) return { done: true }; return { done: false, value: o[i++] }; }, e: function e(_e) { throw _e; }, f: F }; } throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method."); } var normalCompletion = true, didErr = false, err; return { s: function s() { it = it.call(o); }, n: function n() { var step = it.next(); normalCompletion = step.done; return step; }, e: function e(_e2) { didErr = true; err = _e2; }, f: function f() { try { if (!normalCompletion && it["return"] != null) it["return"](); } finally { if (didErr) throw err; } } }; }
function _unsupportedIterableToArray(o, minLen) { if (!o) return; if (typeof o === "string") return _arrayLikeToArray(o, minLen); var n = Object.prototype.toString.call(o).slice(8, -1); if (n === "Object" && o.constructor) n = o.constructor.name; if (n === "Map" || n === "Set") return Array.from(o); if (n === "Arguments" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen); }
function _arrayLikeToArray(arr, len) { if (len == null || len > arr.length) len = arr.length; for (var i = 0, arr2 = new Array(len); i < len; i++) arr2[i] = arr[i]; return arr2; }
var KV_STORE_MARKER = '__init__';
var KeyValueStore = /*#__PURE__*/function () {
  /* A simple key value store implemented in Steamship.
       Instances of the KeyValueStore are identified by its  `namespace`.
        This store_identifier corresponds to a File that will be created with a special tag identifying it.
         Entries of the KeyValueStore are saved as `Tag` objects with:
      * Kind = "KeyValueStore"
      * Name = the key of the (kv) pair
      * Value = a dict set to the value
       Note that the value is always saved as a dict object. To save a string or int, wrap it in a dict.
         WARNING:
       This is essentially a clever hack atop Steamship's tag system to provide mutable key-value storage. It is in the
      steamship.utils package because it's proven useful once or twice. But in general, if you find yourself heavily
      relying upon it, consider reaching out to us at hello@steamship.com to let us know, and we'll up-prioritize
      adding a proper key-value API.
      */

  function KeyValueStore(client) {
    var storeIdentifier = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 'KeyValueStore';
    (0, _classCallCheck2["default"])(this, KeyValueStore);
    (0, _defineProperty2["default"])(this, "client", void 0);
    (0, _defineProperty2["default"])(this, "storeIdentifier", void 0);
    this.client = client;
    this.storeIdentifier = "kv-store-".concat(storeIdentifier);
  }
  (0, _createClass2["default"])(KeyValueStore, [{
    key: "_getFile",
    value: function () {
      var _getFile2 = (0, _asyncToGenerator2["default"])( /*#__PURE__*/_regenerator["default"].mark(function _callee() {
        var orCreate,
          statusFilesP,
          dummyContent,
          textEncoder,
          utf8,
          buffer,
          createP,
          _args = arguments;
        return _regenerator["default"].wrap(function _callee$(_context) {
          while (1) switch (_context.prev = _context.next) {
            case 0:
              orCreate = _args.length > 0 && _args[0] !== undefined ? _args[0] : false;
              _context.next = 3;
              return _file.File.query(this.client, "filetag and kind \"".concat(this.storeIdentifier, "\""));
            case 3:
              statusFilesP = _context.sent;
              if (!(statusFilesP && statusFilesP.output && statusFilesP.output.files && statusFilesP.output.files.length > 0)) {
                _context.next = 6;
                break;
              }
              return _context.abrupt("return", statusFilesP.output.files[0]);
            case 6:
              if (orCreate) {
                _context.next = 8;
                break;
              }
              return _context.abrupt("return", undefined);
            case 8:
              dummyContent = '';
              textEncoder = new _util.TextEncoder();
              utf8 = new Uint8Array(dummyContent.length);
              textEncoder.encodeInto(dummyContent, utf8);
              buffer = Buffer.from(utf8);
              _context.next = 15;
              return _file.File.create(this.client, {
                content: buffer,
                tags: [{
                  kind: this.storeIdentifier,
                  name: KV_STORE_MARKER
                }]
              });
            case 15:
              createP = _context.sent;
              return _context.abrupt("return", createP.output);
            case 17:
            case "end":
              return _context.stop();
          }
        }, _callee, this);
      }));
      function _getFile() {
        return _getFile2.apply(this, arguments);
      }
      return _getFile;
    }()
  }, {
    key: "get",
    value: function () {
      var _get = (0, _asyncToGenerator2["default"])( /*#__PURE__*/_regenerator["default"].mark(function _callee2(key) {
        var file, _iterator, _step, tag;
        return _regenerator["default"].wrap(function _callee2$(_context2) {
          while (1) switch (_context2.prev = _context2.next) {
            case 0:
              _context2.next = 2;
              return this._getFile();
            case 2:
              file = _context2.sent;
              if (file) {
                _context2.next = 5;
                break;
              }
              return _context2.abrupt("return", undefined);
            case 5:
              if (file.tags) {
                _context2.next = 7;
                break;
              }
              return _context2.abrupt("return", undefined);
            case 7:
              _iterator = _createForOfIteratorHelper(file.tags);
              _context2.prev = 8;
              _iterator.s();
            case 10:
              if ((_step = _iterator.n()).done) {
                _context2.next = 17;
                break;
              }
              tag = _step.value;
              if (!(tag.kind == this.storeIdentifier && tag.name == key)) {
                _context2.next = 15;
                break;
              }
              console.log('got tag', tag);
              return _context2.abrupt("return", tag.value);
            case 15:
              _context2.next = 10;
              break;
            case 17:
              _context2.next = 22;
              break;
            case 19:
              _context2.prev = 19;
              _context2.t0 = _context2["catch"](8);
              _iterator.e(_context2.t0);
            case 22:
              _context2.prev = 22;
              _iterator.f();
              return _context2.finish(22);
            case 25:
              return _context2.abrupt("return", undefined);
            case 26:
            case "end":
              return _context2.stop();
          }
        }, _callee2, this, [[8, 19, 22, 25]]);
      }));
      function get(_x) {
        return _get.apply(this, arguments);
      }
      return get;
    }()
  }, {
    key: "delete",
    value: function () {
      var _delete2 = (0, _asyncToGenerator2["default"])( /*#__PURE__*/_regenerator["default"].mark(function _callee3(key) {
        var file, _iterator2, _step2, tag;
        return _regenerator["default"].wrap(function _callee3$(_context3) {
          while (1) switch (_context3.prev = _context3.next) {
            case 0:
              _context3.next = 2;
              return this._getFile();
            case 2:
              file = _context3.sent;
              if (file) {
                _context3.next = 5;
                break;
              }
              return _context3.abrupt("return", false);
            case 5:
              if (file.tags) {
                _context3.next = 7;
                break;
              }
              return _context3.abrupt("return", false);
            case 7:
              _iterator2 = _createForOfIteratorHelper(file.tags);
              _context3.prev = 8;
              _iterator2.s();
            case 10:
              if ((_step2 = _iterator2.n()).done) {
                _context3.next = 18;
                break;
              }
              tag = _step2.value;
              if (!(tag.kind == this.storeIdentifier && tag.name == key)) {
                _context3.next = 16;
                break;
              }
              _context3.next = 15;
              return tag["delete"]();
            case 15:
              return _context3.abrupt("return", true);
            case 16:
              _context3.next = 10;
              break;
            case 18:
              _context3.next = 23;
              break;
            case 20:
              _context3.prev = 20;
              _context3.t0 = _context3["catch"](8);
              _iterator2.e(_context3.t0);
            case 23:
              _context3.prev = 23;
              _iterator2.f();
              return _context3.finish(23);
            case 26:
              return _context3.abrupt("return", false);
            case 27:
            case "end":
              return _context3.stop();
          }
        }, _callee3, this, [[8, 20, 23, 26]]);
      }));
      function _delete(_x2) {
        return _delete2.apply(this, arguments);
      }
      return _delete;
    }()
  }, {
    key: "set",
    value: function () {
      var _set = (0, _asyncToGenerator2["default"])( /*#__PURE__*/_regenerator["default"].mark(function _callee4(key, value) {
        var file;
        return _regenerator["default"].wrap(function _callee4$(_context4) {
          while (1) switch (_context4.prev = _context4.next) {
            case 0:
              _context4.next = 2;
              return this["delete"](key);
            case 2:
              _context4.next = 4;
              return this._getFile(true);
            case 4:
              file = _context4.sent;
              if (file) {
                _context4.next = 7;
                break;
              }
              throw new _steamship_error.SteamshipError({
                statusMessage: 'Unable to create file for tag.'
              });
            case 7:
              return _context4.abrupt("return", _tag.Tag.create(this.client, {
                fileId: file.id,
                kind: this.storeIdentifier,
                name: key,
                value: value
              }));
            case 8:
            case "end":
              return _context4.stop();
          }
        }, _callee4, this);
      }));
      function set(_x3, _x4) {
        return _set.apply(this, arguments);
      }
      return set;
    }() // """Return all key-value entries as a list of (key, value) tuples.
    //
    // If `filter_keys` is provided, only returns keys within that list."""
  }, {
    key: "items",
    value: function () {
      var _items = (0, _asyncToGenerator2["default"])( /*#__PURE__*/_regenerator["default"].mark(function _callee5(filterKeys) {
        var file, ret, _iterator3, _step3, tag;
        return _regenerator["default"].wrap(function _callee5$(_context5) {
          while (1) switch (_context5.prev = _context5.next) {
            case 0:
              _context5.next = 2;
              return this._getFile();
            case 2:
              file = _context5.sent;
              if (!(!file || !file.tags)) {
                _context5.next = 5;
                break;
              }
              return _context5.abrupt("return", []);
            case 5:
              ret = [];
              _iterator3 = _createForOfIteratorHelper(file.tags);
              try {
                for (_iterator3.s(); !(_step3 = _iterator3.n()).done;) {
                  tag = _step3.value;
                  if (tag.kind == this.storeIdentifier && tag.name != KV_STORE_MARKER && (!filterKeys || tag.name && filterKeys.includes(tag.name))) {
                    if (tag.name) {
                      ret.push([tag.name, tag.value]);
                    }
                  }
                }
              } catch (err) {
                _iterator3.e(err);
              } finally {
                _iterator3.f();
              }
              return _context5.abrupt("return", ret);
            case 9:
            case "end":
              return _context5.stop();
          }
        }, _callee5, this);
      }));
      function items(_x5) {
        return _items.apply(this, arguments);
      }
      return items;
    }()
  }, {
    key: "reset",
    value: function () {
      var _reset = (0, _asyncToGenerator2["default"])( /*#__PURE__*/_regenerator["default"].mark(function _callee6() {
        var file;
        return _regenerator["default"].wrap(function _callee6$(_context6) {
          while (1) switch (_context6.prev = _context6.next) {
            case 0:
              _context6.next = 2;
              return this._getFile();
            case 2:
              file = _context6.sent;
              if (!file) {
                _context6.next = 6;
                break;
              }
              _context6.next = 6;
              return file["delete"]();
            case 6:
            case "end":
              return _context6.stop();
          }
        }, _callee6, this);
      }));
      function reset() {
        return _reset.apply(this, arguments);
      }
      return reset;
    }()
  }]);
  return KeyValueStore;
}();
exports.KeyValueStore = KeyValueStore;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJLVl9TVE9SRV9NQVJLRVIiLCJLZXlWYWx1ZVN0b3JlIiwiY2xpZW50Iiwic3RvcmVJZGVudGlmaWVyIiwib3JDcmVhdGUiLCJGaWxlIiwicXVlcnkiLCJzdGF0dXNGaWxlc1AiLCJvdXRwdXQiLCJmaWxlcyIsImxlbmd0aCIsInVuZGVmaW5lZCIsImR1bW15Q29udGVudCIsInRleHRFbmNvZGVyIiwiVGV4dEVuY29kZXIiLCJ1dGY4IiwiVWludDhBcnJheSIsImVuY29kZUludG8iLCJidWZmZXIiLCJCdWZmZXIiLCJmcm9tIiwiY3JlYXRlIiwiY29udGVudCIsInRhZ3MiLCJraW5kIiwibmFtZSIsImNyZWF0ZVAiLCJrZXkiLCJfZ2V0RmlsZSIsImZpbGUiLCJ0YWciLCJjb25zb2xlIiwibG9nIiwidmFsdWUiLCJTdGVhbXNoaXBFcnJvciIsInN0YXR1c01lc3NhZ2UiLCJUYWciLCJmaWxlSWQiLCJpZCIsImZpbHRlcktleXMiLCJyZXQiLCJpbmNsdWRlcyIsInB1c2giXSwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvbGliL2tleV92YWx1ZV9zdG9yZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBBIHNpbXBsZSBrZXktdmFsdWUgc3RvcmUgaW1wbGVtZW50ZWQgYXRvcCBGaWxlcyBhbmQgVGFncy5cblxuaW1wb3J0IHsgVGV4dEVuY29kZXIgfSBmcm9tICd1dGlsJztcblxuaW1wb3J0IHsgRmlsZSB9IGZyb20gJy4vZmlsZS5qcyc7XG5pbXBvcnQgeyBJQXBpQmFzZSB9IGZyb20gJy4vc2hhcmVkL0Jhc2VJbnRlcmZhY2VzLmpzJztcbmltcG9ydCB7IFN0ZWFtc2hpcEVycm9yIH0gZnJvbSAnLi9zdGVhbXNoaXBfZXJyb3IuanMnO1xuaW1wb3J0IHsgVGFnIH0gZnJvbSAnLi90YWcuanMnO1xuaW1wb3J0IHsgVGFzayB9IGZyb20gJy4vdGFzay5qcyc7XG5cbmNvbnN0IEtWX1NUT1JFX01BUktFUiA9ICdfX2luaXRfXyc7XG5cbmV4cG9ydCB0eXBlIERJQ1QgPSB7IFtrZXk6IHN0cmluZ106IHN0cmluZyB8IGJvb2xlYW4gfCBudW1iZXIgfCBESUNUIH07XG5cbmV4cG9ydCBjbGFzcyBLZXlWYWx1ZVN0b3JlIHtcbiAgLyogQSBzaW1wbGUga2V5IHZhbHVlIHN0b3JlIGltcGxlbWVudGVkIGluIFN0ZWFtc2hpcC5cblxuICAgICAgSW5zdGFuY2VzIG9mIHRoZSBLZXlWYWx1ZVN0b3JlIGFyZSBpZGVudGlmaWVkIGJ5IGl0cyAgYG5hbWVzcGFjZWAuXG4gICAgICAgIFRoaXMgc3RvcmVfaWRlbnRpZmllciBjb3JyZXNwb25kcyB0byBhIEZpbGUgdGhhdCB3aWxsIGJlIGNyZWF0ZWQgd2l0aCBhIHNwZWNpYWwgdGFnIGlkZW50aWZ5aW5nIGl0LlxuXG4gICAgICAgIEVudHJpZXMgb2YgdGhlIEtleVZhbHVlU3RvcmUgYXJlIHNhdmVkIGFzIGBUYWdgIG9iamVjdHMgd2l0aDpcbiAgICAgICogS2luZCA9IFwiS2V5VmFsdWVTdG9yZVwiXG4gICAgICAqIE5hbWUgPSB0aGUga2V5IG9mIHRoZSAoa3YpIHBhaXJcbiAgICAgICogVmFsdWUgPSBhIGRpY3Qgc2V0IHRvIHRoZSB2YWx1ZVxuXG4gICAgICBOb3RlIHRoYXQgdGhlIHZhbHVlIGlzIGFsd2F5cyBzYXZlZCBhcyBhIGRpY3Qgb2JqZWN0LiBUbyBzYXZlIGEgc3RyaW5nIG9yIGludCwgd3JhcCBpdCBpbiBhIGRpY3QuXG5cbiAgICAgICAgV0FSTklORzpcblxuICAgICAgVGhpcyBpcyBlc3NlbnRpYWxseSBhIGNsZXZlciBoYWNrIGF0b3AgU3RlYW1zaGlwJ3MgdGFnIHN5c3RlbSB0byBwcm92aWRlIG11dGFibGUga2V5LXZhbHVlIHN0b3JhZ2UuIEl0IGlzIGluIHRoZVxuICAgICAgc3RlYW1zaGlwLnV0aWxzIHBhY2thZ2UgYmVjYXVzZSBpdCdzIHByb3ZlbiB1c2VmdWwgb25jZSBvciB0d2ljZS4gQnV0IGluIGdlbmVyYWwsIGlmIHlvdSBmaW5kIHlvdXJzZWxmIGhlYXZpbHlcbiAgICAgIHJlbHlpbmcgdXBvbiBpdCwgY29uc2lkZXIgcmVhY2hpbmcgb3V0IHRvIHVzIGF0IGhlbGxvQHN0ZWFtc2hpcC5jb20gdG8gbGV0IHVzIGtub3csIGFuZCB3ZSdsbCB1cC1wcmlvcml0aXplXG4gICAgICBhZGRpbmcgYSBwcm9wZXIga2V5LXZhbHVlIEFQSS5cbiAgICAgICovXG5cbiAgY2xpZW50OiBJQXBpQmFzZTtcbiAgc3RvcmVJZGVudGlmaWVyOiBzdHJpbmc7XG5cbiAgcHVibGljIGNvbnN0cnVjdG9yKGNsaWVudDogSUFwaUJhc2UsIHN0b3JlSWRlbnRpZmllciA9ICdLZXlWYWx1ZVN0b3JlJykge1xuICAgIHRoaXMuY2xpZW50ID0gY2xpZW50O1xuICAgIHRoaXMuc3RvcmVJZGVudGlmaWVyID0gYGt2LXN0b3JlLSR7c3RvcmVJZGVudGlmaWVyfWA7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgX2dldEZpbGUob3JDcmVhdGUgPSBmYWxzZSk6IFByb21pc2U8RmlsZSB8IHVuZGVmaW5lZD4ge1xuICAgIGNvbnN0IHN0YXR1c0ZpbGVzUCA9IGF3YWl0IEZpbGUucXVlcnkoXG4gICAgICB0aGlzLmNsaWVudCxcbiAgICAgIGBmaWxldGFnIGFuZCBraW5kIFwiJHt0aGlzLnN0b3JlSWRlbnRpZmllcn1cImBcbiAgICApO1xuXG4gICAgaWYgKFxuICAgICAgc3RhdHVzRmlsZXNQICYmXG4gICAgICBzdGF0dXNGaWxlc1Aub3V0cHV0ICYmXG4gICAgICBzdGF0dXNGaWxlc1Aub3V0cHV0LmZpbGVzICYmXG4gICAgICBzdGF0dXNGaWxlc1Aub3V0cHV0LmZpbGVzLmxlbmd0aCA+IDBcbiAgICApIHtcbiAgICAgIHJldHVybiBzdGF0dXNGaWxlc1Aub3V0cHV0LmZpbGVzWzBdO1xuICAgIH1cblxuICAgIGlmICghb3JDcmVhdGUpIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuXG4gICAgY29uc3QgZHVtbXlDb250ZW50ID0gJyc7XG4gICAgY29uc3QgdGV4dEVuY29kZXIgPSBuZXcgVGV4dEVuY29kZXIoKTtcbiAgICBjb25zdCB1dGY4ID0gbmV3IFVpbnQ4QXJyYXkoZHVtbXlDb250ZW50Lmxlbmd0aCk7XG4gICAgdGV4dEVuY29kZXIuZW5jb2RlSW50byhkdW1teUNvbnRlbnQsIHV0ZjgpO1xuICAgIGNvbnN0IGJ1ZmZlciA9IEJ1ZmZlci5mcm9tKHV0ZjgpO1xuXG4gICAgY29uc3QgY3JlYXRlUCA9IGF3YWl0IEZpbGUuY3JlYXRlKHRoaXMuY2xpZW50LCB7XG4gICAgICBjb250ZW50OiBidWZmZXIsXG4gICAgICB0YWdzOiBbeyBraW5kOiB0aGlzLnN0b3JlSWRlbnRpZmllciwgbmFtZTogS1ZfU1RPUkVfTUFSS0VSIH1dLFxuICAgIH0pO1xuICAgIHJldHVybiBjcmVhdGVQLm91dHB1dDtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBnZXQoa2V5OiBzdHJpbmcpOiBQcm9taXNlPERJQ1QgfCB1bmRlZmluZWQ+IHtcbiAgICBjb25zdCBmaWxlID0gYXdhaXQgdGhpcy5fZ2V0RmlsZSgpO1xuICAgIGlmICghZmlsZSkge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG5cbiAgICBpZiAoIWZpbGUudGFncykge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IHRhZyBvZiBmaWxlLnRhZ3MpIHtcbiAgICAgIGlmICh0YWcua2luZCA9PSB0aGlzLnN0b3JlSWRlbnRpZmllciAmJiB0YWcubmFtZSA9PSBrZXkpIHtcbiAgICAgICAgY29uc29sZS5sb2coJ2dvdCB0YWcnLCB0YWcpO1xuICAgICAgICByZXR1cm4gdGFnLnZhbHVlO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZGVsZXRlKGtleTogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgY29uc3QgZmlsZSA9IGF3YWl0IHRoaXMuX2dldEZpbGUoKTtcbiAgICBpZiAoIWZpbGUpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBpZiAoIWZpbGUudGFncykge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIGZvciAoY29uc3QgdGFnIG9mIGZpbGUudGFncykge1xuICAgICAgaWYgKHRhZy5raW5kID09IHRoaXMuc3RvcmVJZGVudGlmaWVyICYmIHRhZy5uYW1lID09IGtleSkge1xuICAgICAgICBhd2FpdCB0YWcuZGVsZXRlKCk7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBzZXQoa2V5OiBzdHJpbmcsIHZhbHVlOiBESUNUKTogUHJvbWlzZTxUYXNrPFRhZz4+IHtcbiAgICBhd2FpdCB0aGlzLmRlbGV0ZShrZXkpO1xuICAgIGNvbnN0IGZpbGUgPSBhd2FpdCB0aGlzLl9nZXRGaWxlKHRydWUpO1xuICAgIGlmICghZmlsZSkge1xuICAgICAgdGhyb3cgbmV3IFN0ZWFtc2hpcEVycm9yKHtcbiAgICAgICAgc3RhdHVzTWVzc2FnZTogJ1VuYWJsZSB0byBjcmVhdGUgZmlsZSBmb3IgdGFnLicsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gVGFnLmNyZWF0ZSh0aGlzLmNsaWVudCwge1xuICAgICAgZmlsZUlkOiBmaWxlLmlkLFxuICAgICAga2luZDogdGhpcy5zdG9yZUlkZW50aWZpZXIsXG4gICAgICBuYW1lOiBrZXksXG4gICAgICB2YWx1ZTogdmFsdWUsXG4gICAgfSk7XG4gIH1cblxuICAvLyBcIlwiXCJSZXR1cm4gYWxsIGtleS12YWx1ZSBlbnRyaWVzIGFzIGEgbGlzdCBvZiAoa2V5LCB2YWx1ZSkgdHVwbGVzLlxuICAvL1xuICAvLyBJZiBgZmlsdGVyX2tleXNgIGlzIHByb3ZpZGVkLCBvbmx5IHJldHVybnMga2V5cyB3aXRoaW4gdGhhdCBsaXN0LlwiXCJcIlxuICBwdWJsaWMgYXN5bmMgaXRlbXMoZmlsdGVyS2V5cz86IHN0cmluZ1tdKTogUHJvbWlzZTxbc3RyaW5nLCBESUNUXVtdPiB7XG4gICAgY29uc3QgZmlsZSA9IGF3YWl0IHRoaXMuX2dldEZpbGUoKTtcbiAgICBpZiAoIWZpbGUgfHwgIWZpbGUudGFncykge1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cblxuICAgIGNvbnN0IHJldDogW3N0cmluZywgRElDVF1bXSA9IFtdO1xuICAgIGZvciAoY29uc3QgdGFnIG9mIGZpbGUudGFncykge1xuICAgICAgaWYgKFxuICAgICAgICB0YWcua2luZCA9PSB0aGlzLnN0b3JlSWRlbnRpZmllciAmJlxuICAgICAgICB0YWcubmFtZSAhPSBLVl9TVE9SRV9NQVJLRVIgJiZcbiAgICAgICAgKCFmaWx0ZXJLZXlzIHx8ICh0YWcubmFtZSAmJiBmaWx0ZXJLZXlzLmluY2x1ZGVzKHRhZy5uYW1lKSkpXG4gICAgICApIHtcbiAgICAgICAgaWYgKHRhZy5uYW1lKSB7XG4gICAgICAgICAgcmV0LnB1c2goW3RhZy5uYW1lLCB0YWcudmFsdWVdKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmV0O1xuICB9XG5cbiAgcHVibGljIGFzeW5jIHJlc2V0KCkge1xuICAgIGNvbnN0IGZpbGUgPSBhd2FpdCB0aGlzLl9nZXRGaWxlKCk7XG4gICAgaWYgKGZpbGUpIHtcbiAgICAgIGF3YWl0IGZpbGUuZGVsZXRlKCk7XG4gICAgfVxuICB9XG59XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztBQUVBO0FBRUE7QUFFQTtBQUNBO0FBQStCO0FBQUE7QUFBQTtBQUcvQixJQUFNQSxlQUFlLEdBQUcsVUFBVTtBQUFDLElBSXRCQyxhQUFhO0VBQ3hCO0FBQ0Y7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0VBVUUsdUJBQW1CQyxNQUFnQixFQUFxQztJQUFBLElBQW5DQyxlQUFlLHVFQUFHLGVBQWU7SUFBQTtJQUFBO0lBQUE7SUFDcEUsSUFBSSxDQUFDRCxNQUFNLEdBQUdB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